<dom-module id="admin-page">
  <template>
    <style>
      div#json-editor-gui-nav {
        padding-left: 8px;
      }

      #json-editor-gui-table {
        table-layout: fixed;
        width: 100%;
      }
      
      .json-editor-gui-index {
        overflow: hidden;
        width: 100px;
      }
    </style>
    <div id="admin-div">
      <div class="container">
        <h2>Administration</h2>
        <p>Manage your plugins and more.</p>

        <div id="json-editor-gui">
          <nav>
            <div class="nav-wrapper">
              <div id="json-editor-gui-nav" class="col s12">
                <a class="breadcrumb">config</a>
              </div>
            </div>
          </nav>
          <table class="responsive-table" id="json-editor-gui-table">
            <thead>
              <tr>
                <th>Index</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody id="json-editor-gui-settings">

            </tbody>
          </table>
        </div>
      </div>
    </div>
  </template>
</dom-module>
<script>
  var global_config;

  function get_node(obj, node_id) {
    if (node_id === "")
      return obj;

    var node_names = node_id.split(",")
    var node = obj;
    node_names.forEach(function(name) {
      node = node[name];
    });
    return node;
  }

  function on_nav_clicked(event) {
    load_node(global_config, $(this).attr("data-nodepath"))
    return false;
  }

  function on_item_clicked(event) {
    load_node(global_config, $(this).attr("data-nodepath"));
    return false;
  }

  function reset_nav() {
    var nav = $("#json-editor-gui-nav").empty()
    return nav.append($("<a>").addClass("breadcrumb")
                              .attr("data-nodepath", "")
                              .attr("href", "#!")
                              .click(on_nav_clicked)
                              .text("config")
    );
  }

  function show_value_editor(event) {
    var input = $("<input>", {
                  "val": $(this).text(),
                  "type": "text"
                }).addClass("json-editor-gui-input")
                  .blur(hide_value_editor)
    $(this).replaceWith(input);
    input.focus();
    input.select();
  }

  function hide_value_editor(event) {
    var span = $("<span>", {
                  "text": $(this).val()
               }).addClass("json-editor-gui-value")
                 .click(show_value_editor)
    $(this).replaceWith(span)
  }

  function load_node(obj, node_id) {
    console.log(obj, node_id)
    path = node_id.split(",");
    node = get_node(obj, node_id);
    var nav = reset_nav();
    var settings = $("#json-editor-gui-settings").empty()

    if (node_id !== ""){
      path.forEach(function(name, index, arr) {
        nav.append(
          $("<a>").addClass("breadcrumb")
                   .attr("data-nodepath", arr.slice(0, index+1).join(","))
                   .attr("href", "#!")

                   .click(on_nav_clicked)
                   .text(name)
        );
      });
    }

    $.each(node, function(index, value) {
      var nodepath = (node_id === "")? index: [node_id, index].join(",")
      if (typeof value == "object"){
        settings.append(
          $("<tr>").append(
            $("<td>").attr("colspan", 2)
                     .addClass("json-editor-gui-index")
                     .append(
               $("<a>").attr("data-nodepath", nodepath)
                       .attr("href","#!")
                       .click(on_item_clicked)
                       .text(index)
            )
          )
        )
      } else if (typeof value === "boolean"){
        settings.append(
          $("<tr>").append(
            $("<td>").attr("data-nodepath", nodepath)
                     .addClass("json-editor-gui-index")
                     .text(index),
            $("<td>").append(
              $("<input>", {
                "type": "checkbox",
                "id": ["checkbox", nodepath].join(",")
              }).addClass("json-editor-gui-value")
                .attr("checked", value),
              $("<label>").attr("for", ["checkbox", nodepath].join(","))
            )
          )
        )
      } else {
        settings.append(
          $("<tr>").append(
            $("<td>").attr("data-nodepath", nodepath)
                     .addClass("json-editor-gui-index")
                     .text(index),
            $("<td>").append(
              $("<span>").attr("data-nodepath", nodepath)
                         .addClass("json-editor-gui-value")
                         .text(value)
                         .click(show_value_editor)
            )
          )
        )
      }
    })
  }

  function load_config(config_obj) {
    global_config = config_obj;
    load_node(config_obj, "")
  }

  Polymer({
      is: "admin-page",
      attached: function() {
        site.plugin_api("admin", "config", {}, function(data){
          if (!data.success){
            site.toast("Error getting current config file.");
            return;
          }
          config = data.config;

          // $("#settings-div").append(parse_config(config));
          // $(".collapsible").collapsible({accordion: true});
          load_config(config)

        })
      }
  });
</script>
