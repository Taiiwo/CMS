<dom-module id="admin-page">
    <template>
        <div id="admin-div">
          <div class="container">
            <h2>Administration</h2>
            <p>Manage your plugins and more.</p>

            <div id="json-editor-gui">
              <nav>
                <div class="nav-wrapper">
                  <div id="json-editor-gui-nav" class="col s12">
                    <a class="breadcrumb">config</a>
                  </div>
                </div>
              </nav>
              <div id="json-editor-gui-settings">

              </div>
            </div>

          </div>
        </div>
    </template>
</dom-module>
<script>
  var global_config;

  function get_node(obj, node_id) {
    if (node_id === "")
      return obj;

    var node_names = node_id.split(",")
    var node = obj;
    node_names.forEach(function(name) {
      node = node[name];
    });
    return node;
  }

  function on_nav_clicked(event) {
    load_node(global_config, $(this).attr("data-nodepath"))
    return false;
  }

  function on_item_clicked(event) {
    load_node(global_config, $(this).attr("data-nodepath"));
    return false;
  }

  function reset_nav() {
    var nav = $("#json-editor-gui-nav").empty()
    return nav.append($("<a>").addClass("breadcrumb")
                              .attr("data-nodepath", "")
                              .attr("href", "#!")
                              .click(on_nav_clicked)
                              .text("config")
    );
  }

  function load_node(obj, node_id) {
    path = node_id.split(",");
    node = get_node(obj, node_id);
    var nav = reset_nav();
    var settings = $("#json-editor-gui-settings").empty()

    if (node_id !== ""){
      path.forEach(function(name, index, arr) {
        nav.append(
          $("<a>").addClass("breadcrumb")
                  .attr("data-nodepath", arr.slice(0, index).join(","))
                  .attr("href", "#!")
                  .click(on_nav_clicked)
                  .text(name)
        );
      });
    }

    $.each(node, function(index, value) {
      if (typeof value == "object"){
        settings.append(
          $("<a>").attr("data-nodepath", (node_id === "")? index: [node_id, index].join(","))
                  .attr("href","#!")
                  .click(on_item_clicked)
                  .text(index),
          $("<br />")
        )
      } else {
        settings.append(
          $("<span>").attr("data-nodepath", index)
                     .addClass("json-editor-gui-label")
                     .text(index),
          $("<input>").attr("data-nodepath", index)
                      .addClass("json-editor-gui-input")
                      .val(value)

        )
      }
    })
  }

  function load_config(config_obj) {
    global_config = config_obj;
    load_node(config_obj, "")
  }

  Polymer({
      is: "admin-page",
      attached: function() {
        site.plugin_api("admin", "config", {}, function(data){
          if (!data.success){
            site.toast("Error getting current config file.");
            return;
          }
          config = data.config;

          load_config(config)

        })
      }
  });
</script>
