<link rel="import" href="../layout/taii-list.html" />
<link rel="import" href="../layout/taii-markdown.html" />
<link rel="import" href="../layout/taii-input.html" />
<dom-module id="payment-methods">
    <template>
        <style>
            /**/
        </style>
        <taii-markdown>
Payment methods
---------------
Below is a list of all your payment methods. Here you can add or remove your
payment methods.
        </taii-markdown>
        <div class="container">

          <taii-list></taii-list>
        </div>
        <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
          <a class="btn-floating btn-large red" href="#/add-card">
            <i class="large material-icons">add</i>
          </a>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "payment-methods",
        attached: function() {
          function on_remove_method() {
            site.plugin_api(
              "payment",
              "remove-card",
              {"card_id": $(this).attr("data-method-id")},
              function(data){
                if (data.success)
                  site.toast("Payment method successfully removed.");
                else
                  site.toast("Error.");
              }
            );
          }
          function to_date(ts){
            return Date(ts).slice(0, 15);
          }
          function to_time(ts){
            return Date(ts).slice(16, 24);
          }
          if (!site.userAuthed()) {
            site.route('/login');
            site.toast('Authentication required');
            return false;
          }
          var list = $('taii-list')[0];
          site.plugin_api('payment', 'get-payment-methods', {}, function(methods){
            for (var i in methods.payment_methods){
              var method = methods.payment_methods[i];
              list.add_item(
                method['cc-number'],
                $('<span>')
                  .text(
                    "Added on " + to_date(method.added) +
                    " at " + to_time(method.added)
                  )
                  .append(
                    $('<taii-input>')
                      .attr('iid', 'default-' + i)
                      .attr('type', 'check')
                      .attr('label', 'default')
                  )
                ,
                "credit_card",
                $('<span>').append(
                  $('<i>')
                    .addClass('material-icons')
                    .text("delete")
                    .click(on_remove_method)
                    .attr("data-method-id", i)
                  ,
                  $('<i>')
                    .addClass('material-icons')
                    .text("send")
                    .attr("data-method-id", i)
                )
              )
            }
          });
        }
    });
</script>
